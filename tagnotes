#!/usr/bin/env perl
use Mojolicious::Lite;

use FindBin '$Bin';
use lib "$Bin/lib";
use TagNotes;
use TagNotes::Util qw(shorten trim);
use List::Util 'first';

plugin 'Config';

# configure tagnotes helper
my $tagnotes = TagNotes->new(notes_dir => app->config->{notes_dir});
app->helper(tagnotes => sub {$tagnotes});

# make util functions accessible as helpers
app->helper($_ => sub {shift; &$_(@_)}) for qw(shorten trim);

get '/' => sub {
    my $c = shift;
    $c->stash(notes => $c->tagnotes->notes);
} => 'home';

get '/note/:uuid' => sub {
    my $c = shift;

    # lookup
    my $uuid    = $c->param('uuid');
    my $notes   = $c->tagnotes->notes;
    my $note    = first {$_->path =~ /note_$uuid\.md$/} @$notes;
    return $c->reply->not_found unless defined $note;

    # prepare
    $c->stash(note => $note, notes => $notes);
} => 'note';

app->start;
